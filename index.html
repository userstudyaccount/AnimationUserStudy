<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Animation Comparison Study</title>
  <script src="jspsych/jspsych.js"></script>
	<script src="jspsych/plugin-html-keyboard-response.js"></script>
	<script src="jspsych/plugin-image-keyboard-response.js"></script>
	<script src="jspsych/plugin-video-button-response.js"></script>
  <script src="jspsych/plugin-html-button-response.js"></script>
  <script src="jspsych/plugin-survey-html-form.js"></script>
  <script src="jspsych/plugin-preload.js"></script>
  <script src="user_study_text.js"></script>
  <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
	<style>
    video { width: 300px; margin: 10px; }
    .video-container { display: flex; justify-content: center; }
    .ranking-form { text-align: center; margin-top: 20px; }
  </style>
</head>
<body></body>
<script>
	var jsPsych = initJsPsych({

	});

	var clips = Array.from({ length: 50 }, (_, i) => i);
	var models = ["style_gt", "mp", "smoodi", "ours"];
	var model_ids = ['A', 'B', 'C'];

	const participant_id = jsPsych.randomization.randomID(8);


	var timeline = [
  {
    type: jsPsychPreload,
    video: clips.flatMap(clip => models.map(m => `stimuli/${m}_${clip}.mp4`))
  }
];

	var welcome = {
		type: jsPsychHtmlKeyboardResponse,
		stimulus:
		`<h2 style="text-align: center;"> Animation User Study</h2>
		<div style="max-width: 600px; margin: 0 auto; text-align: left;">
			<p> This study is to evaluate different models for a Siggraph-Asia submission. We appreciate your participation.</p>
			In this study, you will be shown a series of videos generated by three different models.
			You are given a text description that describe content of the motion, and a reference video that shows the style of the motion.
			Your task is to rank the models based on how well they preserve the semantic meaning of the text description and reflect the style of the reference motion, as well as their motion quality (considering artifacts such as foot sliding, jittering, etc).</p>
			<p><strong>Press any key to begin.</strong></p>

		</div>`,
		post_trial_gap: 2000
	};
	timeline.push(welcome);


	function submitDataAndEndExperiment() {
		const submissionURL = 'https://script.google.com/macros/s/AKfycbxYKVLrRzImimHl7FTD8Wa9EdssXpQcBvVoAyOvadKLKwwY4Ozc45AH20uG7AQwYeyJRg/exec';

		const trial_data = jsPsych.data.get().filter({ task: "user_response" }).values();

		fetch(submissionURL, {
			method: 'POST',
			mode: 'no-cors',
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify({
				participant_id: participant_id,
				values: trial_data
			})
		});

		jsPsych.endExperiment("Your data has been submitted. Thank you!");
	}


	clips.forEach((clip_id, index) => {
		const model_order = models;
		const top_video_html = `<div>
			<strong>Style</strong>
			<video controls autoplay muted loop><source src='stimuli/style_gt_${clip_id}.mp4' type='video/mp4'></video></div>`;
		const bottom_videos_html =
			`
			<div class='video-container'>
			<div><video controls autoplay muted loop><source src='stimuli/mp_${clip_id}.mp4' type='video/mp4'></video><p>Model A</p></div>
			<div><video controls autoplay muted loop><source src='stimuli/smoodi_${clip_id}.mp4' type='video/mp4'></video><p>Model B</p></div>
			<div><video controls autoplay muted loop><source src='stimuli/ours_${clip_id}.mp4' type='video/mp4'></video><p>Model C</p></div>
			</div>`;

		const titles = ["Content preservation", "Style reflection", "Motion quality"]

		const trial = {
			type: jsPsychSurveyHtmlForm,
			preamble: `<h3> Sample ${clip_id}</h3>
			<div>
				<strong>Content:
				</strong>
				${userStudyText[clip_id]}
			</div>
			${top_video_html}${bottom_videos_html}`,
			html: `
				<p>Rank each model (1 = best, 3 = worst):</p>
				<div class="ranking-container" style="display: flex; justify-content: center; gap: 30px;">
					${titles.map((title, i) => `
						<div class="ranking-column" style="border: 1px solid #ccc; padding: 10px; width: 200px;">
							<h4 style="text-align: center; margin-top: 0;">${title}</h4>

							${model_ids.map(m => `
								<label style="display: block; margin-bottom: 5px;">Model ${m}:
									<input name="clip_${clip_id}_model_${m}_q_${i}" type="radio" value="1" required>1
									<input name="clip_${clip_id}_model_${m}_q_${i}" type="radio" value="2">2
									<input name="clip_${clip_id}_model_${m}_q_${i}" type="radio" value="3">3
								</label>
							`).join("")}
						</div>
					`).join("")}
				</div>

			`,
			data: {
				task: 'user_response',
				clip_id: clip_id,
			}
		};

		timeline.push(trial);
	});



	timeline.push({
		type: jsPsychHtmlButtonResponse,
		stimulus: '<p>Thank you for participating!</p><p>Your data is being submitted...</p>',
		choices: ['Finish'],
		on_finish: submitDataAndEndExperiment
	});


	jsPsych.run(timeline);


</script>
</html>