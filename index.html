<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Animation Comparison Study</title>
  <script src="jspsych/jspsych.js"></script>
	<script src="jspsych/plugin-html-keyboard-response.js"></script>
	<script src="jspsych/plugin-image-keyboard-response.js"></script>
	<script src="jspsych/plugin-video-button-response.js"></script>
  <script src="jspsych/plugin-html-button-response.js"></script>
  <script src="jspsych/plugin-survey-html-form.js"></script>
  <script src="jspsych/plugin-preload.js"></script>
  <!-- <script src="trial_generator.js"></script> -->
  <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
	<style>
    video { width: 300px; margin: 10px; }
    .video-container { display: flex; justify-content: center; }
    .ranking-form { text-align: center; margin-top: 20px; }
  </style>
</head>
<body></body>
<script>
	var jsPsych = initJsPsych({
		on_finish: function() {
			jsPsych.data.displayData();
		}
	});

	var clips = Array.from({ length: 2 }, (_, i) => i);
	var models = ["style_gt", "mp", "smoodi", "ours"];
	var model_ids = ['A', 'B', 'C'];

	const participant_id = jsPsych.randomization.randomID(8);


	var timeline = [
  {
    type: jsPsychPreload,
    video: clips.flatMap(clip => models.map(m => `stimuli/${m}_${clip}.mp4`))
  }
];

	var welcome = {
		type: jsPsychHtmlKeyboardResponse,
		stimulus:
		`<h3> Animation User Study</h3>
		<div>
		<p>Welcome to the animation user study. You will be given a reference style motion on the leftmost, and a text description, the output motions are expected to match the reference style and also repect the semantic meaning of the text description. The output motions are generated using three different models, please rank them in terms of semantic preservation, style reflection and motion quality.</p><p> Press any key to begin.</p>
		</div>`,
		post_trial_gap: 2000
	};
	timeline.push(welcome);




	function shuffle(array) {
		let a = array.slice();
		for (let i = a.length - 1; i > 0; i--) {
			const j = Math.floor(Math.random() * (i + 1));
			[a[i], a[j]] = [a[j], a[i]];
		}
		return a;
	}

	clips.forEach((clip_id, index) => {
		const model_order = models;
		const top_video_html = `<div><video controls autoplay muted loop><source src='stimuli/style_gt_${clip_id}.mp4' type='video/mp4'></video><p>Style reference</p></div>`;
		const bottom_videos_html =
			`
			<div class='video-container'>
			<div><video controls autoplay muted loop><source src='stimuli/mp_${clip_id}.mp4' type='video/mp4'></video><p>Model A</p></div>
			<div><video controls autoplay muted loop><source src='stimuli/smoodi_${clip_id}.mp4' type='video/mp4'></video><p>Model B</p></div>
			<div><video controls autoplay muted loop><source src='stimuli/ours_${clip_id}.mp4' type='video/mp4'></video><p>Model C</p></div>
			</div>`;

		const trial = {
			type: jsPsychSurveyHtmlForm,
			preamble: `<h3> Video ${clip_id}</h3> ${top_video_html}${bottom_videos_html}`,
			html: `
				<div class='ranking-form'>
					<p>Rank each model (1 = best, 3 = worst):</p>
					${model_ids.map(m => `
						<label>Model ${m}:
							<input name="rank_${clip_id}_${m}" type="radio" value="1" required>1
							<input name="rank_${clip_id}_${m}" type="radio" value="2">2
							<input name="rank_${clip_id}_${m}" type="radio" value="3">3
						</label><br>
					`).join("")}
				</div>
			`,
			data: {
				task: 'user_response',
				clip_id: clip_id,
			}
		};

		timeline.push(trial);
	});



	timeline.push({
		type: jsPsychHtmlButtonResponse,
		stimulus: '<p>Thank you for participating!</p><p>Your data is being submitted...</p>',
		choices: ['Finish'],
		on_finish: function() {
			const submissionURL = 'https://script.google.com/macros/s/AKfycbxYKVLrRzImimHl7FTD8Wa9EdssXpQcBvVoAyOvadKLKwwY4Ozc45AH20uG7AQwYeyJRg/exec';

			const trial_data = jsPsych.data.get().filter({ task: "user_response" }).values();

			fetch(submissionURL, {
				method: 'POST',
				mode: 'no-cors', // prevents blocking, but no response back
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({
					participant_id: participant_id,
					values: trial_data }),
			});
		}
	});


	jsPsych.run(timeline);


</script>
</html>