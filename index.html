<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Animation Comparison Study</title>
  <script src="jspsych/jspsych.js"></script>
	<script src="jspsych/plugin-html-keyboard-response.js"></script>
	<script src="jspsych/plugin-image-keyboard-response.js"></script>
	<script src="jspsych/plugin-video-button-response.js"></script>
  <script src="jspsych/plugin-html-button-response.js"></script>
  <script src="jspsych/plugin-survey-html-form.js"></script>
  <script src="jspsych/plugin-preload.js"></script>
  <script src="user_study_text.js"></script>
  <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
	<style>
    video { width: 500px; margin: 3px; }
    .video-container {  display: flex; justify-content: center; }
    .ranking-form { text-align: center; margin-top: 20px; }
  </style>
</head>
<body></body>
<script>
	var jsPsych = initJsPsych({

	});

	var total_clips = 50;
	var clips = Array.from({ length: total_clips }, (_, i) => i);
	var models = ["style_gt", "mp", "smoodi", "ours"];

	const participant_id = jsPsych.randomization.randomID(8);


	var timeline = [
  {
    type: jsPsychPreload,
    video: clips.flatMap(clip => models.map(m => `stimuli/${m}_${clip}.mp4`))
  }
];

	var welcome = {
		type: jsPsychHtmlKeyboardResponse,
		stimulus:
		`<h2 style="text-align: center;"> Animation User Study</h2>
		<div style="max-width: 600px; margin: 0 auto; text-align: left;">
			<p> This study is to evaluate different models for a Siggraph-Asia submission. The survey should take about 10 - 15 mins. We appreciate your participation.</p>
			In this study, you will be shown a series of videos generated by two different models, based on two conditions: <strong>content</strong> and <strong>style</strong>.
			On each page, you are given a text description that describe expected <strong>content</strong> of the motion, and a reference video (in <span style="color: #c0392b;">red</span>) that shows the expected <strong>style</strong> of the motion. Two models (in <span style="color: #007a00;">green</span>) will be shown at a time,
			and your task is to choose your preferred model based on how well they preserve the semantic meaning of the text description and reflect the style of the reference motion, as well as their motion quality (considering artifacts such as foot sliding, jittering, etc).</p>
			<p><strong>Press any key to begin.</strong></p>

		</div>`,
		post_trial_gap: 2000
	};
	timeline.push(welcome);


	function submitDataAndEndExperiment() {
		const submissionURL = 'https://script.google.com/macros/s/AKfycbxYKVLrRzImimHl7FTD8Wa9EdssXpQcBvVoAyOvadKLKwwY4Ozc45AH20uG7AQwYeyJRg/exec';

		const trial_data = jsPsych.data.get().filter({ task: "user_response" }).values();

		fetch(submissionURL, {
			method: 'POST',
			mode: 'no-cors',
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify({
				participant_id: participant_id,
				values: trial_data
			})
		});

		jsPsych.endExperiment("Your data has been submitted. Thank you!");
	}

	// Shuffle using Fisher-Yates algorithm
	for (let i = clips.length - 1; i > 0; i--) {
		const j = Math.floor(Math.random() * (i + 1));
		[clips[i], clips[j]] = [clips[j], clips[i]];
	}

	// Retrieve a subset (e.g., first 10 shuffled clips)
	var subset_size = 15;
	var selected_clips = clips.slice(0, subset_size);

	selected_clips.forEach((clip_id, index) => {
		const model_order = models;
		const top_video_html = `<div>
			<strong>Style reference</strong>
			<video controls autoplay muted loop><source src='stimuli/style_gt_${clip_id}.mp4' type='video/mp4'></video></div>`;
		const bottom_videos_html_1 =
			`
			<div class='video-container'>
			<div><video controls autoplay muted loop><source src='stimuli/mp_${clip_id}.mp4' type='video/mp4'></video>  <div style="margin-top: 8px; font-weight: bold;">Model 1</div></div>
			<div><video controls autoplay muted loop><source src='stimuli/ours_${clip_id}.mp4' type='video/mp4'></video> <div style="margin-top: 8px; font-weight: bold;">Model 2</div></div>
			</div>`;
		const bottom_videos_html_2 =
			`
			<div class='video-container'>
			<div><video controls autoplay muted loop><source src='stimuli/smoodi_${clip_id}.mp4' type='video/mp4'></video><div style="margin-top: 8px; font-weight: bold;">Model 1</div></div>
			<div><video controls autoplay muted loop><source src='stimuli/ours_${clip_id}.mp4' type='video/mp4'></video><div style="margin-top: 8px; font-weight: bold;">Model 2</div></div>
			</div>`;

		const titles = ["Content preservation", "Style reflection", "Motion quality"]
		const hints = [`<div>Is the <span style="color: #007a00;">green</span> person doing what's described in the top sentence?</div>`,
			`<div>Is the <span style="color: #007a00;">green</span> person moving in a similar fashion to the <span style="color: #c0392b;">red</span> person?</div>`,
			`<div>Is the <span style="color: #007a00;">green</span> person moving in a way that looks realistic and natural?</div>`
		]

		const trial_1 = {
			type: jsPsychSurveyHtmlForm,
			preamble: `<h3>(Sample ${2*index+1}/${2*subset_size}): ${userStudyText[clip_id]}</h3>`,
			html: `
			${top_video_html}${bottom_videos_html_1}
				<p>Compare the following two models or if you cannot decide:
						<button type="button" id="skip-button" style="font-size: 16px;">Skip this comparison</button>
				</p>
				<div class="ranking-container" style="display: flex; flex-direction: column; justify-content: center; gap: 30px;">
					${titles.map((title, i) => `
						<div class="ranking-column" style="border: 1px solid #ccc; padding: 10px; width: 800px; margin-bottom: 15px;">
							<!-- Title above -->
							<div style="font-weight: bold; margin-bottom: 10px;">
								${title}: ${hints[i]}
							</div>

							<!-- Buttons below -->
							<div style="display: flex; gap: 20px; justify-content: center;">
								<label style="font-size: 18px; display: flex; align-items: center; gap: 8px;">
									<input style="transform: scale(1.5);" name="clip_${clip_id}_model_mp_q_${i}" type="radio" value="0"> Left
								</label>
								<label style="font-size: 18px; display: flex; align-items: center; gap: 8px;">
									<input style="transform: scale(1.5);" name="clip_${clip_id}_model_mp_q_${i}" type="radio" value="1"> Right
								</label>
								<label style="font-size: 18px; display: flex; align-items: center; gap: 8px;">
									<input style="transform: scale(1.5);" name="clip_${clip_id}_model_mp_q_${i}" type="radio" value="2"> Inconclusive
								</label>
							</div>
						</div>
					`).join("")}


				</div>
			`,
			data: {
				task: 'user_response',
				clip_id: clip_id,
				model: "MP",
			},
			on_load: () => {
				document.getElementById('skip-button').addEventListener('click', () => {
					jsPsych.finishTrial({ skipped: true });
				});
			},
			on_finish: (data) => {
				if (data.skipped) {
					// Clean up so it's not treated as a valid user response
					delete data.task;
					delete data.clip_id;
					delete data.model;
				}
			}
		};
		const trial_2 = {
			type: jsPsychSurveyHtmlForm,
			preamble: `<h3> Sample ${2*index+2}/${2*subset_size}): ${userStudyText[clip_id]}</h3>
			${top_video_html}${bottom_videos_html_2}`,
			html: `
				<p>Compare the following two models or if you cannot decide:
						<button type="button" id="skip-button" style="font-size: 16px;">Skip this comparison</button>
				</p>
				<div class="ranking-container" style="display: flex; flex-direction: column; justify-content: center; gap: 30px;">
					${titles.map((title, i) => `
						<div class="ranking-column" style="border: 1px solid #ccc; padding: 10px; width: 800px; margin-bottom: 15px;">
							<!-- Title above -->
							<div style="font-weight: bold; margin-bottom: 10px;">
								${title}: ${hints[i]}
							</div>

							<!-- Buttons below -->
							<div style="display: flex; gap: 20px; justify-content: center;">
								<label style="font-size: 18px; display: flex; align-items: center; gap: 8px;">
									<input style="transform: scale(1.5);" name="clip_${clip_id}_model_smoodi_q_${i}" type="radio" value="0"> Left
								</label>
								<label style="font-size: 18px; display: flex; align-items: center; gap: 8px;">
									<input style="transform: scale(1.5);" name="clip_${clip_id}_model_smoodi_q_${i}" type="radio" value="1"> Right
								</label>
								<label style="font-size: 18px; display: flex; align-items: center; gap: 8px;">
									<input style="transform: scale(1.5);" name="clip_${clip_id}_model_smoodi_q_${i}" type="radio" value="2"> Inconclusive
								</label>
							</div>
						</div>
					`).join("")}
				</div>
			`,
			data: {
				task: 'user_response',
				clip_id: clip_id,
				model: "SMOODI",
			},
			on_load: () => {
				document.getElementById('skip-button').addEventListener('click', () => {
					jsPsych.finishTrial({ skipped: true });
				});
			},
			on_finish: (data) => {
				if (data.skipped) {
					// Clean up so it's not treated as a valid user response
					delete data.task;
					delete data.clip_id;
					delete data.model;
				}
			}
		};

		timeline.push([trial_1, trial_2]);
	});


	jsPsych.data.addProperties({ participant_id });
	timeline.push({
		type: jsPsychHtmlButtonResponse,
		stimulus: `
		<p>Thank you for participating!</p><p>Your data is being submitted...</p>
		<p><strong>Your completion code is:</strong></p>
		<p style="font-size: 24px; color: red;"><strong>${participant_id}</strong></p>
		<p>Please copy and paste this code into the HIT page to receive credit.</p>
		`,
		choices: ['Finish'],
		on_finish: submitDataAndEndExperiment,
		on_load: () => {
			setTimeout(() => jsPsych.finishTrial(), 30000); // auto-finish after 30s
		}
	});


	jsPsych.run(timeline);


</script>
</html>